<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Veeam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="min-h-screen">
        <!-- Cabeçalho -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">
                        <i class="fas fa-envelope mr-2"></i>Monitoramento Veeam
                    </h1>
                    <div class="flex items-center space-x-4">
                        <div id="current-date" class="text-sm bg-blue-700 px-3 py-1 rounded-full"></div>
                        <button id="refresh-btn" class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded-full">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="container mx-auto px-4 py-6">
            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="flex flex-wrap items-end gap-4">
                    <div class="flex-1 min-w-[260px] relative">
                        <label for="date-range-input" class="block text-sm font-medium text-gray-700 mb-1">Período</label>
                        <input type="text" id="date-range-input" readonly placeholder="Selecione o período" class="w-full p-2 border border-gray-300 rounded-md cursor-pointer bg-white" autocomplete="off">
                        <div id="date-range-picker" class="absolute z-10 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 p-4 hidden w-[320px]">
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="block text-xs text-gray-500 mb-1">Início</label>
                                    <input type="date" id="date-range-start" class="w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-xs text-gray-500 mb-1">Fim</label>
                                    <input type="date" id="date-range-end" class="w-full p-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button id="date-range-clear" type="button" class="text-xs px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700">Limpar</button>
                                <button id="date-range-apply" type="button" class="text-xs px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white">Aplicar</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button id="today-backup-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center gap-2" title="Visualizar backups do dia atual">
                            <i class="fas fa-calendar-day"></i>
                            Backup de Hoje
                        </button>
                    </div>
                    <div>
                        <button id="apply-filter" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                            Aplicar Filtro
                        </button>
                    </div>
                    <div>
                        <button id="clear-filter" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Total de E-mails</h3>
                    <div class="flex items-center justify-between">
                        <span id="total-emails" class="text-3xl font-bold text-blue-600">0</span>
                        <i class="fas fa-envelope text-blue-400 text-4xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Processados</h3>
                    <div class="flex items-center justify-between">
                        <span id="processed-emails" class="text-3xl font-bold text-green-600">0</span>
                        <i class="fas fa-check-circle text-green-400 text-4xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Pendentes</h3>
                    <div class="flex items-center justify-between">
                        <span id="pending-emails" class="text-3xl font-bold text-yellow-600">0</span>
                        <i class="fas fa-clock text-yellow-400 text-4xl"></i>
                    </div>
                </div>
            </div>

            <!-- Gráfico -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Status dos E-mails (Últimos 7 dias)</h2>
                <div class="h-64">
                    <canvas id="status-chart"></canvas>
                </div>
            </div>

            <!-- Resumo dos Backups -->
            <div id="backup-summary-section" class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-2">Resumo dos Backups dos Dispositivos</h2>
                <div id="backup-summary-info" class="mb-2 text-gray-700 text-sm">
                    <!-- Texto informativo será preenchido via JS -->
                </div>
                <div class="flex flex-wrap gap-4 mb-4">
                    <div class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span id="summary-success" class="font-bold text-green-700">0</span>
                        <span class="text-green-700">Sucesso</span>
                    </div>
                    <div class="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        <span id="summary-warning" class="font-bold text-yellow-700">0</span>
                        <span class="text-yellow-700">Aviso</span>
                    </div>
                    <div class="flex items-center gap-2 bg-red-50 px-4 py-2 rounded">
                        <i class="fas fa-times-circle text-red-500"></i>
                        <span id="summary-error" class="font-bold text-red-700">0</span>
                        <span class="text-red-700">Erro</span>
                    </div>
                </div>
                <!-- Tabela de dispositivos por status -->
                <div id="backup-summary-table" class="overflow-x-auto">
                    <!-- Conteúdo preenchido via JS -->
                </div>
            </div>

            <!-- Lista de E-mails -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                    <h2 class="text-xl font-semibold text-gray-800">E-mails Recentes</h2>
                    <!-- Barra de pesquisa por assunto -->
                    <div class="w-full md:w-72">
                        <input id="search-subject-input" type="text" placeholder="Pesquisar por assunto..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assunto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="emails-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dados serão inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        Mostrando <span id="showing-count">0</span> de <span id="total-count">0</span> e-mails
                    </div>
                    <div class="flex space-x-2">
                        <button id="prev-page" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50" disabled>Anterior</button>
                        <button id="next-page" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50" disabled>Próxima</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal de Detalhes -->
        <div id="email-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Detalhes do E-mail</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="email-detail-content">
                        <!-- Conteúdo será inserido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentPage = 1;
        const itemsPerPage = 10;
        let allEmails = [];
        let filteredEmails = [];
        let statusChart = null;

        // Elementos DOM
        const emailsTableBody = document.getElementById('emails-table-body');
        const totalEmailsSpan = document.getElementById('total-emails');
        const processedEmailsSpan = document.getElementById('processed-emails');
        const pendingEmailsSpan = document.getElementById('pending-emails');
        const showingCountSpan = document.getElementById('showing-count');
        const totalCountSpan = document.getElementById('total-count');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const applyFilterBtn = document.getElementById('apply-filter');
        const clearFilterBtn = document.getElementById('clear-filter');
        const refreshBtn = document.getElementById('refresh-btn');
        const currentDateSpan = document.getElementById('current-date');
        const emailDetailModal = document.getElementById('email-detail-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const emailDetailContent = document.getElementById('email-detail-content');
        const statusChartCanvas = document.getElementById('status-chart');

        // Elementos DOM extras para o novo filtro
        const dateRangeInput = document.getElementById('date-range-input');
        const dateRangePicker = document.getElementById('date-range-picker');
        const dateRangeStart = document.getElementById('date-range-start');
        const dateRangeEnd = document.getElementById('date-range-end');
        const dateRangeApply = document.getElementById('date-range-apply');
        const dateRangeClear = document.getElementById('date-range-clear');
        const todayBackupBtn = document.getElementById('today-backup-btn');
        const searchSubjectInput = document.getElementById('search-subject-input');

        // Elementos DOM para o resumo dos backups
        const summarySuccess = document.getElementById('summary-success');
        const summaryWarning = document.getElementById('summary-warning');
        const summaryError = document.getElementById('summary-error');
        const backupSummaryInfo = document.getElementById('backup-summary-info');

        // Funções
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR').slice(0, 5);
        }

        function formatSimpleDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function getStatusBadge(isProcessed) {
            if (isProcessed) {
                return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Processado</span>';
            } else {
                return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendente</span>';
            }
        }

        async function fetchEmails() {
            try {
                const response = await fetch('/api/emails/');
                if (!response.ok) throw new Error('Erro ao carregar e-mails');
                allEmails = await response.json();
                // Buscar dados de backup para cada e-mail (se não vier junto)
                // Suporte para API que já retorna backup_data junto do e-mail
                // Caso não venha, buscar manualmente
                const needsBackupData = allEmails.some(email => !email.backup_data);
                if (needsBackupData) {
                    await Promise.all(allEmails.map(async (email) => {
                        try {
                            const resp = await fetch(`/api/email-data/by-email/${email.id}`);
                            if (resp.ok) {
                                email.backup_data = await resp.json();
                            } else {
                                email.backup_data = [];
                            }
                        } catch {
                            email.backup_data = [];
                        }
                    }));
                }
                filteredEmails = [...allEmails];
                updateDashboard();
                renderEmailsTable();
                updateChart();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados. Tente novamente.');
            }
        }

        async function fetchEmailDetails(emailId) {
            try {
                const response = await fetch(`/api/email-data/by-email/${emailId}`);
                if (!response.ok) throw new Error('Erro ao carregar detalhes');
                return await response.json();
            } catch (error) {
                console.error('Erro:', error);
                return [];
            }
        }

        // Função para atualizar o resumo dos backups
        function updateBackupSummary() {
            // Contadores por status baseados na tabela emails (não nos jobs)
            let success = 0, warning = 0, error = 0;
            filteredEmails.forEach(email => {
                if (email.is_processed === 1 || email.is_processed === true) {
                    success++;
                } else if (email.is_processed === 0 || email.is_processed === false) {
                    warning++;
                } else {
                    error++;
                }
            });

            summarySuccess.textContent = success;
            summaryWarning.textContent = warning;
            summaryError.textContent = error;

            // Texto informativo
            let infoText = '';
            if (success + warning + error === 0) {
                infoText = 'Nenhum dado de backup encontrado para os dispositivos no período selecionado.';
            } else if (error > 0) {
                infoText = `Atenção: ${error} e-mail(s) com status desconhecido.`;
            } else if (warning > 0) {
                infoText = `Aviso: ${warning} e-mail(s) pendente(s) de processamento.`;
            } else {
                infoText = 'Todos os e-mails foram processados com sucesso!';
            }
            backupSummaryInfo.textContent = infoText;

            // Atualizar tabela de resumo (mantém jobs)
            updateBackupSummaryTable(
                filteredEmails.flatMap(email => email.backup_jobs || [])
            );
        }

        function updateBackupSummaryTable(backupJobs) {
            const tableContainer = document.getElementById('backup-summary-table');
            tableContainer.innerHTML = '';

            if (!backupJobs || backupJobs.length === 0) {
                tableContainer.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        Nenhum dado de backup encontrado para os dispositivos no período selecionado.
                    </div>
                `;
                return;
            }

            // Agrupar por status
            const groupedByStatus = backupJobs.reduce((acc, item) => {
                const status = item.status ? (item.status.charAt(0).toUpperCase() + item.status.slice(1).toLowerCase()) : 'Máquinas virtuais';
                if (!acc[status]) {
                    acc[status] = [];
                }
                acc[status].push(item);
                return acc;
            }, {});

            // Ordenar chaves
            const sortedStatusKeys = Object.keys(groupedByStatus).sort((a, b) => {
                const order = ['Success', 'Warning', 'Error'];
                return order.indexOf(a) - order.indexOf(b);
            });

            sortedStatusKeys.forEach(status => {
                const items = groupedByStatus[status];
                // Cabeçalho da seção
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'font-semibold text-gray-800 mt-4';
                sectionHeader.textContent = `${status} (${items.length})`;
                tableContainer.appendChild(sectionHeader);

                // Tabela para os itens
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200 mb-4';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Dispositivo</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Hora</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Size</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Duração</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${items.map(item => {
                            // Buscar status e data da tabela emails (email relacionado)
                            // Supondo que o item tenha email_id e que filteredEmails está acessível
                            let email = null;
                            if (item.email_id && Array.isArray(filteredEmails)) {
                                email = filteredEmails.find(e => e.id === item.email_id);
                            }
                            // Data do e-mail
                            let data = email && email.date ? email.date : '-';
                            // Status do e-mail
                            let statusEmail = email && typeof email.is_processed !== 'undefined'
                                ? (email.is_processed ? 'Processado' : 'Pendente')
                                : '-';
                            // Hora (mantém lógica anterior)
                            let hora = '-';
                            if (item.data) {
                                hora = item.data;
                            } else if (item.start_time) {
                                const parts = item.start_time.split(' ');
                                hora = parts[0] || '-';
                            } else if (item.created_at) {
                                hora = item.created_at.split(' ')[0];
                            }
                            // Total Size e Duração
                            const totalSize = item.total_size || item.totalSize || '-';
                            const duracao = item.duration || item.duracao || '-';
                            return `
                            <tr>
                                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.job_name || item.host || 'N/A'}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${data}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${hora}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                                    <span class="px-2 py-1 text-xs rounded-full ${
                                        statusEmail === 'Processado' ? 'bg-green-100 text-green-800' :
                                        statusEmail === 'Pendente' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${statusEmail}
                                    </span>
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${totalSize}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${duracao}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;
                tableContainer.appendChild(table);
            });
        }

        function renderEmailsTable() {
            emailsTableBody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const emailsToShow = filteredEmails.slice(startIndex, endIndex);
            
            if (emailsToShow.length === 0) {
                emailsTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum e-mail encontrado</td>
                    </tr>
                `;
                return;
            }
            
            emailsToShow.forEach(email => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${email.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${email.subject || 'Sem assunto'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(email.date + 'T' + email.sent_time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(email.is_processed)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="showEmailDetail(${email.id})" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </td>
                `;
                emailsTableBody.appendChild(row);
            });
            
            updatePagination();
            updateBackupSummary();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredEmails.length / itemsPerPage);
            
            showingCountSpan.textContent = Math.min(
                currentPage * itemsPerPage, 
                filteredEmails.length
            );
            totalCountSpan.textContent = filteredEmails.length;
            
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function updateDashboard() {
            totalEmailsSpan.textContent = allEmails.length;
            
            const processed = allEmails.filter(email => email.is_processed).length;
            processedEmailsSpan.textContent = processed;
            
            const pending = allEmails.length - processed;
            pendingEmailsSpan.textContent = pending;
        }

        async function showEmailDetail(emailId) {
            try {
                // Mostrar loading
                emailDetailContent.innerHTML = `
                    <div class="flex justify-center items-center h-32">
                        <i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>
                    </div>
                `;
                emailDetailModal.classList.remove('hidden');

                // Buscar detalhes do e-mail, dados antigos, jobs e VMs
                const [emailResponse, dataResponse, jobsResponse] = await Promise.all([
                    fetch(`/api/emails/${emailId}`),
                    fetchEmailDetails(emailId),
                    fetch(`/api/backup-jobs/by-email/${emailId}`)
                ]);
                if (!emailResponse.ok) throw new Error('Erro ao carregar e-mail');
                const email = await emailResponse.json();
                const jobs = jobsResponse.ok ? await jobsResponse.json() : [];

                // Buscar VMs do primeiro job (se houver)
                let vms = [];
                if (jobs.length > 0) {
                    const vmsResp = await fetch(`/api/backup-vms/by-job/${jobs[0].id}`);
                    vms = vmsResp.ok ? await vmsResp.json() : [];
                }

                // Renderizar conteúdo
                emailDetailContent.innerHTML = `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Informações do E-mail</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">ID</p>
                                    <p class="font-medium">${email.id}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Assunto</p>
                                    <p class="font-medium">${email.subject || 'Sem assunto'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Data/Hora</p>
                                    <p class="font-medium">${formatDate(email.date + 'T' + email.sent_time)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Status</p>
                                    <p class="font-medium">${email.is_processed ? 'Processado' : 'Pendente'}</p>
                                </div>
                                ${email.processed_date ? `
                                <div>
                                    <p class="text-sm text-gray-500">Processado em</p>
                                    <p class="font-medium">${formatDate(email.processed_date)}</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Dados do Backup</h4>
                        ${dataResponse.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Host</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${dataResponse.map(item => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.host}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ip || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span class="px-2 py-1 text-xs rounded-full ${
                                                item.status === 'Success' ? 'bg-green-100 text-green-800' :
                                                item.status === 'Warning' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }">
                                                ${item.status}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatSimpleDate(item.date)}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : `
                        <div class="bg-gray-50 p-4 rounded-lg text-center text-gray-500">
                            Nenhum dado de backup encontrado para este e-mail
                        </div>
                        `}
                    </div>
                    ${jobs.length > 0 ? `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Resumo do Job</h4>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">Job</p>
                                    <p class="font-medium">${jobs[0].job_name || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Criado por</p>
                                    <p class="font-medium">${jobs[0].created_by || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Criado em</p>
                                    <p class="font-medium">${jobs[0].created_at || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">VMs processadas</p>
                                    <p class="font-medium">${jobs[0].processed_vms || '-'} de ${jobs[0].processed_vms_total || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Success</p>
                                    <p class="font-medium">${jobs[0].summary_success || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Warning</p>
                                    <p class="font-medium">${jobs[0].summary_warning || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Error</p>
                                    <p class="font-medium">${jobs[0].summary_error || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Início</p>
                                    <p class="font-medium">${jobs[0].start_time || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Fim</p>
                                    <p class="font-medium">${jobs[0].end_time || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Duração</p>
                                    <p class="font-medium">${jobs[0].duration || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Total Size</p>
                                    <p class="font-medium">${jobs[0].total_size || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Backup Size</p>
                                    <p class="font-medium">${jobs[0].backup_size || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Data Read</p>
                                    <p class="font-medium">${jobs[0].data_read || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Dedupe</p>
                                    <p class="font-medium">${jobs[0].dedupe || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Transferred</p>
                                    <p class="font-medium">${jobs[0].transferred || '-'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Compression</p>
                                    <p class="font-medium">${jobs[0].compression || '-'}</p>
                                </div>
                            </div>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">VMs do Job</h4>
                        ${vms.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Início</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fim</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tamanho</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lido</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Transferido</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Duração</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${vms.map(vm => `
                                    <tr>
                                        <td class="px-4 py-2">${vm.name}</td>
                                        <td class="px-4 py-2">${vm.status}</td>
                                        <td class="px-4 py-2">${vm.start_time}</td>
                                        <td class="px-4 py-2">${vm.end_time}</td>
                                        <td class="px-4 py-2">${vm.size}</td>
                                        <td class="px-4 py-2">${vm.read}</td>
                                        <td class="px-4 py-2">${vm.transferred}</td>
                                        <td class="px-4 py-2">${vm.duration}</td>
                                        <td class="px-4 py-2">${vm.details}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : `
                        <div class="bg-gray-50 p-4 rounded-lg text-center text-gray-500">
                            Nenhuma VM encontrada para este job
                        </div>
                        `}
                    </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Erro:', error);
                emailDetailContent.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">
                                    Erro ao carregar detalhes do e-mail. Tente novamente.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateChart() {
            // Agrupar e-mails por data e status (últimos 7 dias)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const filtered = allEmails.filter(email => {
                const emailDate = new Date(email.date);
                return emailDate >= sevenDaysAgo;
            });
            
            const groupedByDate = filtered.reduce((acc, email) => {
                const date = formatSimpleDate(email.date);
                if (!acc[date]) {
                    acc[date] = { processed: 0, pending: 0 };
                }
                if (email.is_processed) {
                    acc[date].processed++;
                } else {
                    acc[date].pending++;
                }
                return acc;
            }, {});
            
            const labels = Object.keys(groupedByDate).sort();
            const processedData = labels.map(date => groupedByDate[date].processed);
            const pendingData = labels.map(date => groupedByDate[date].pending);
            
            if (statusChart) {
                statusChart.destroy();
            }
            
            statusChart = new Chart(statusChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Processados',
                            data: processedData,
                            backgroundColor: '#10B981',
                            borderColor: '#10B981',
                            borderWidth: 1
                        },
                        {
                            label: 'Pendentes',
                            data: pendingData,
                            backgroundColor: '#F59E0B',
                            borderColor: '#F59E0B',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function filterBySubject(subject) {
            const search = subject.trim().toLowerCase();
            if (!search) {
                filteredEmails = [...allEmails];
            } else {
                filteredEmails = allEmails.filter(email =>
                    (email.subject || '').toLowerCase().includes(search)
                );
            }
            currentPage = 1;
            renderEmailsTable();
        }

        function filterByDateRange(startDate, endDate) {
            if (!startDate && !endDate) {
                filteredEmails = [...allEmails];
            } else {
                filteredEmails = allEmails.filter(email => {
                    // email.date está no formato 'YYYY-MM-DD'
                    if (startDate && endDate) {
                        return email.date >= startDate && email.date <= endDate;
                    } else if (startDate) {
                        return email.date >= startDate;
                    } else if (endDate) {
                        return email.date <= endDate;
                    }
                    return true;
                });
            }
            // Se houver texto na barra de pesquisa, aplicar também o filtro de assunto
            if (searchSubjectInput.value.trim()) {
                filteredEmails = filteredEmails.filter(email =>
                    (email.subject || '').toLowerCase().includes(searchSubjectInput.value.trim().toLowerCase())
                );
            }
            currentPage = 1;
            renderEmailsTable();
        }

        // Event Listeners
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderEmailsTable();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredEmails.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderEmailsTable();
            }
        });

        applyFilterBtn.addEventListener('click', () => {
            filterByDateRange(dateRangeStart.value, dateRangeEnd.value);
        });

        clearFilterBtn.addEventListener('click', () => {
            dateRangeStart.value = '';
            dateRangeEnd.value = '';
            dateRangeInput.value = '';
            dateRangePicker.classList.add('hidden');
            filterByDateRange(null, null);
        });

        refreshBtn.addEventListener('click', () => {
            fetchEmails();
        });

        closeModalBtn.addEventListener('click', () => {
            emailDetailModal.classList.add('hidden');
        });

        // Função para abrir/fechar o picker
        dateRangeInput.addEventListener('click', () => {
            dateRangePicker.classList.toggle('hidden');
        });

        // Fechar picker ao clicar fora
        document.addEventListener('mousedown', (e) => {
            if (!dateRangePicker.contains(e.target) && e.target !== dateRangeInput) {
                dateRangePicker.classList.add('hidden');
            }
        });

        // Atualizar placeholder do input
        function updateDateRangeInput() {
            if (dateRangeStart.value && dateRangeEnd.value) {
                const start = new Date(dateRangeStart.value);
                const end = new Date(dateRangeEnd.value);
                dateRangeInput.value = `${start.toLocaleDateString('pt-BR')} - ${end.toLocaleDateString('pt-BR')}`;
            } else if (dateRangeStart.value) {
                const start = new Date(dateRangeStart.value);
                dateRangeInput.value = `A partir de ${start.toLocaleDateString('pt-BR')}`;
            } else if (dateRangeEnd.value) {
                const end = new Date(dateRangeEnd.value);
                dateRangeInput.value = `Até ${end.toLocaleDateString('pt-BR')}`;
            } else {
                dateRangeInput.value = '';
            }
        }

        // Aplicar filtro ao clicar em "Aplicar"
        dateRangeApply.addEventListener('click', () => {
            dateRangePicker.classList.add('hidden');
            updateDateRangeInput();
            filterByDateRange(dateRangeStart.value, dateRangeEnd.value);
        });

        // Limpar filtro ao clicar em "Limpar"
        dateRangeClear.addEventListener('click', () => {
            dateRangeStart.value = '';
            dateRangeEnd.value = '';
            dateRangeInput.value = '';
            dateRangePicker.classList.add('hidden');
            filterByDateRange(null, null);
        });

        // Atualizar input ao mudar datas
        dateRangeStart.addEventListener('change', updateDateRangeInput);
        dateRangeEnd.addEventListener('change', updateDateRangeInput);

        // Ajustar datas máximas/mínimas
        document.addEventListener('DOMContentLoaded', () => {
            // Atualizar data atual
            const today = new Date();
            currentDateSpan.textContent = today.toLocaleDateString('pt-BR');
            
            // Definir data máxima nos filtros como hoje
            const todayStr = new Date().toISOString().split('T')[0];
            dateRangeStart.max = todayStr;
            dateRangeEnd.max = todayStr;
            
            // Carregar dados
            fetchEmails();
        });

        // Funções globais para acesso no HTML
        window.showEmailDetail = showEmailDetail;

        todayBackupBtn.addEventListener('click', () => {
            const todayStr = new Date().toISOString().split('T')[0];
            // Limpa o filtro visual e aplica o filtro do dia atual
            dateRangeStart.value = todayStr;
            dateRangeEnd.value = todayStr;
            updateDateRangeInput();
            filterByDateRange(todayStr, todayStr);
        });

        // Event Listener para pesquisa por assunto
        searchSubjectInput.addEventListener('input', (e) => {
            filterBySubject(e.target.value);
        });
    </script>
</body>
</html>